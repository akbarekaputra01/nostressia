name: Sync backend to Hugging Face hub

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest

    environment:
      name: Production
      url: https://akbarekaputra01-nostressia-backend.hf.space

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          lfs: true

      - name: Push backend to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          set -e

          # ✅ 1) GANTI INI sesuai nama folder backend kamu di GitHub
          BACKEND_DIR="nostressia-backend"

          # ✅ 2) URL Space HF (pakai lowercase yang kamu pakai sebelumnya)
          REPO_URL="https://akbarekaputra01:${HF_TOKEN}@huggingface.co/spaces/akbarekaputra01/nostressia-backend.git"

          echo "Checking backend dir..."
          ls -la
          test -d "$BACKEND_DIR"

          echo "Copy backend content to temp repo..."
          rm -rf /tmp/hf-backend
          mkdir -p /tmp/hf-backend
          rsync -av --delete "$BACKEND_DIR"/ /tmp/hf-backend/

          cd /tmp/hf-backend

          echo "Init git repo..."
          git init
          git lfs install

          git config user.email "actions@github.com"
          git config user.name "github-actions"

          echo "Commit and push..."
          git add -A
          git commit -m "Sync backend from GitHub ${GITHUB_SHA}" || echo "No changes to commit"

          git branch -M main
          git remote add origin "$REPO_URL"
          git push -u origin main --force
